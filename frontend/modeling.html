<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-WEBSIM : Modeling Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        
        /* 채팅 말풍선 등장 애니메이션 */
        .message-enter { animation: slideIn 0.3s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }

        /* 스택 아이템 등장/호버 애니메이션 */
        .stack-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-left: 4px solid #3b82f6; }
        .stack-item:hover { transform: translateX(-4px); border-left-color: #a855f7; }
        .stack-enter { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 
            0% { opacity: 0; transform: scale(0.9) translateX(20px); } 
            100% { opacity: 1; transform: scale(1) translateX(0); } 
        }

        /* 커스텀 스크롤바 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 border-b border-slate-700 h-16 shrink-0 px-6 flex items-center justify-between z-10">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-purple-600 rounded flex items-center justify-center font-bold text-white shadow-lg shadow-blue-500/20">
                <i class="fa-solid fa-robot"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-tight text-white">AI Architect <span class="text-slate-500 font-normal">| Modeling Assistant</span></h1>
            </div>
        </div>

        <div class="flex-1 max-w-xl mx-8">
            <div class="flex justify-between text-xs text-slate-400 mb-1">
                <span>Model Completeness</span>
                <span id="progress-text" class="text-blue-400 font-mono">0%</span>
            </div>
            <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-full w-0 transition-all duration-700 ease-out"></div>
            </div>
        </div>

        <button class="text-slate-400 hover:text-white transition">
            <i class="fa-solid fa-gear"></i>
        </button>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <main class="flex-1 flex flex-col bg-slate-950 relative">
            
            <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-6">
                
                <div class="flex gap-4 message-enter">
                    <div class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-microchip text-blue-400"></i>
                    </div>
                    <div class="flex flex-col gap-2 max-w-2xl">
                        <div class="bg-slate-800 border border-slate-700 p-4 rounded-r-xl rounded-bl-xl text-sm leading-relaxed text-slate-300 shadow-sm">
                            안녕하세요! 시뮬레이션 모델링을 도와드리겠습니다.<br>
                            어떤 시스템을 시뮬레이션하고 싶으신가요?
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="fillAndSend('반도체 Fab 공정 최적화 해줘')" class="px-3 py-1.5 bg-slate-900 border border-slate-700 rounded-full text-xs text-blue-400 hover:bg-slate-800 hover:border-blue-500 transition cursor-pointer">
                                + 반도체 Fab 공정
                            </button>
                            <button onclick="fillAndSend('CPU 아키텍처 성능 분석하고 싶어')" class="px-3 py-1.5 bg-slate-900 border border-slate-700 rounded-full text-xs text-purple-400 hover:bg-slate-800 hover:border-purple-500 transition cursor-pointer">
                                + CPU 아키텍처
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="p-5 bg-slate-900 border-t border-slate-800">
                <div class="relative max-w-4xl mx-auto">
                    <input type="text" id="user-input" 
                        class="w-full bg-slate-800 text-white placeholder-slate-500 border border-slate-700 rounded-xl pl-5 pr-12 py-4 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition shadow-lg"
                        placeholder="시뮬레이션 요구사항을 입력하세요..." 
                        onkeypress="if(event.key === 'Enter') handleInput()">
                    <button onclick="handleInput()" class="absolute right-3 top-3 w-10 h-10 bg-blue-600 hover:bg-blue-500 text-white rounded-lg flex items-center justify-center transition shadow-lg shadow-blue-500/30">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </main>

        <aside class="w-96 bg-slate-900 border-l border-slate-800 flex flex-col shadow-2xl z-20">
            
            <div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 backdrop-blur">
                <div>
                    <h2 class="font-bold text-white text-sm">Model Context</h2>
                    <p class="text-xs text-slate-500 mt-0.5">Selected Metrics & Parameters</p>
                </div>
                <span id="stack-count" class="bg-blue-900 text-blue-300 px-2 py-0.5 rounded text-xs font-bold border border-blue-800">0</span>
            </div>

            <div id="stack-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-900">
                <div id="empty-state" class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50">
                    <i class="fa-regular fa-clone text-4xl mb-3"></i>
                    <p class="text-xs">No metrics selected yet.</p>
                </div>
            </div>

            <div class="p-5 border-t border-slate-800 bg-slate-900">
                <button id="run-btn" disabled class="w-full py-3 bg-slate-800 text-slate-500 rounded-lg font-bold text-sm transition-all duration-300 flex items-center justify-center gap-2 cursor-not-allowed">
                    <span>Generate Simulation</span>
                </button>
            </div>
        </aside>

    </div>

    <script>
        // --- 상태 관리 변수 ---
        const chatContainer = document.getElementById('chat-container');
        const stackContainer = document.getElementById('stack-container');
        const emptyState = document.getElementById('empty-state');
        const runBtn = document.getElementById('run-btn');
        
        let metrics = [];
        let targetSimulation = null; // 'fab' or 'cpu'

        // 퀵 버튼용 헬퍼
        function fillAndSend(text) {
            document.getElementById('user-input').value = text;
            handleInput();
        }

        // 유저 메시지 처리
        function handleInput() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;
            
            sendUserMessage(text);
            input.value = '';
        }

        function sendUserMessage(text) {
            // 유저 말풍선 추가
            const div = document.createElement('div');
            div.className = 'flex justify-end message-enter mb-6';
            div.innerHTML = `
                <div class="bg-blue-600 text-white px-5 py-3 rounded-l-2xl rounded-tr-2xl text-sm max-w-xl shadow-lg shadow-blue-900/20">
                    ${text}
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();

            // AI 응답 시뮬레이션 (딜레이 연출)
            setTimeout(() => {
                generateAIResponse(text);
            }, 800);
        }

        // AI 응답 및 시뮬레이션 타겟팅 로직
        function generateAIResponse(text) {
            let responseText = "";
            let suggestions = [];
            
            // 1. 반도체 Fab 관련 키워드 감지
            if (text.includes("반도체") || text.includes("공정") || text.includes("웨이퍼") || text.includes("Fab")) {
                
                targetSimulation = 'fab'; // 타겟 설정
                
                responseText = "반도체 Fab 공정 시뮬레이션을 설계합니다. 핵심 성과 지표인 <strong>생산량(Throughput)</strong>과 <strong>수율(Yield)</strong> 분석 모델을 구성할까요?";
                suggestions = [
                    { id: 'throughput', name: 'Throughput', desc: 'Wafer output per hour', icon: 'fa-box-open', color: 'text-green-400' },
                    { id: 'yield', name: 'Yield Rate', desc: 'Defect analysis model', icon: 'fa-chart-pie', color: 'text-purple-400' },
                    { id: 'bottleneck', name: 'Bottleneck Check', desc: 'Identify slowest step', icon: 'fa-triangle-exclamation', color: 'text-red-400' }
                ];

            // 2. CPU 아키텍처 관련 키워드 감지
            } else if (text.includes("CPU") || text.includes("아키텍처") || text.includes("컴퓨터") || text.includes("하드웨어") || text.includes("성능")) {
                
                targetSimulation = 'cpu'; // 타겟 설정
                
                responseText = "하드웨어 아키텍처 분석 모델을 설계합니다. <strong>코어 성능</strong>과 <strong>전력 효율</strong> 간의 트레이드오프 분석을 준비했습니다.";
                suggestions = [
                    { id: 'perf_score', name: 'Performance', desc: 'Compute capability score', icon: 'fa-microchip', color: 'text-blue-400' },
                    { id: 'power_eff', name: 'Power (TDP)', desc: 'Watt consumption model', icon: 'fa-bolt', color: 'text-yellow-400' },
                    { id: 'cost_eff', name: 'Unit Cost', desc: 'Manufacturing cost', icon: 'fa-dollar-sign', color: 'text-green-400' }
                ];

            // 3. 기타/기본
            } else {
                targetSimulation = 'fab'; // 데모용 기본값
                responseText = `"${text}"에 대한 모델링을 시작합니다. 먼저 분석하고 싶은 핵심 지표(KPI)를 선택해주세요.`;
                suggestions = [
                    { id: 'generic_time', name: 'Processing Time', desc: 'Time per task', icon: 'fa-stopwatch', color: 'text-slate-200' },
                    { id: 'generic_cost', name: 'Operational Cost', desc: 'Cost per unit', icon: 'fa-dollar-sign', color: 'text-green-400' }
                ];
            }

            // AI 말풍선 및 추천 칩 렌더링
            const wrapper = document.createElement('div');
            wrapper.className = 'flex gap-4 message-enter mb-6';
            
            let suggestionsHTML = suggestions.map(s => `
                <button onclick="addToStack('${s.id}', '${s.name}', '${s.desc}', '${s.icon}', '${s.color}', this)" 
                    class="group flex items-center gap-3 px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg hover:border-blue-500 hover:bg-slate-700/50 transition-all text-left min-w-[200px] shadow-sm">
                    <div class="w-8 h-8 rounded bg-slate-900 flex items-center justify-center border border-slate-700 group-hover:border-blue-500/50 transition">
                        <i class="fa-solid ${s.icon} ${s.color}"></i>
                    </div>
                    <div>
                        <div class="text-slate-200 text-xs font-bold group-hover:text-white">${s.name}</div>
                        <div class="text-slate-500 text-[10px]">${s.desc}</div>
                    </div>
                    <i class="fa-solid fa-plus text-slate-600 ml-auto group-hover:text-blue-400"></i>
                </button>
            `).join('');

            wrapper.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center shrink-0 shadow-lg">
                    <i class="fa-solid fa-microchip text-blue-400"></i>
                </div>
                <div class="flex flex-col gap-3 max-w-2xl">
                    <div class="bg-slate-800 border border-slate-700 p-4 rounded-r-xl rounded-bl-xl text-sm leading-relaxed text-slate-300 shadow-sm">
                        ${responseText}
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        ${suggestionsHTML}
                    </div>
                </div>
            `;
            chatContainer.appendChild(wrapper);
            scrollToBottom();
        }

        // 우측 스택에 추가하는 로직
        function addToStack(id, name, desc, icon, color, btnElement) {
            // 중복 방지
            if (metrics.find(m => m.id === id)) return;

            metrics.push({ id, name });

            // Empty state 제거
            if (emptyState) emptyState.style.display = 'none';

            // 버튼 시각적 비활성화 (체크 표시)
            if(btnElement) {
                btnElement.classList.add('opacity-50', 'cursor-default');
                btnElement.onclick = null;
                btnElement.querySelector('.fa-plus').className = "fa-solid fa-check text-green-500 ml-auto";
            }

            // 스택 아이템 생성 및 애니메이션
            const item = document.createElement('div');
            item.className = 'stack-item stack-enter bg-slate-800 p-4 rounded-lg border border-slate-700 shadow-lg relative group overflow-hidden';
            item.innerHTML = `
                <div class="absolute top-0 right-0 p-2 opacity-0 group-hover:opacity-100 transition cursor-pointer text-slate-500 hover:text-red-400" onclick="removeStack(this, '${id}')">
                    <i class="fa-solid fa-xmark"></i>
                </div>
                <div class="flex items-start gap-3">
                    <div class="mt-1 w-8 h-8 rounded bg-slate-900 flex items-center justify-center border border-slate-600/50">
                        <i class="fa-solid ${icon} ${color} text-sm"></i>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-slate-200">${name}</h4>
                        <p class="text-xs text-slate-500 mt-1">${desc}</p>
                        <div class="mt-2 flex gap-1">
                            <span class="text-[10px] bg-slate-900 text-slate-400 px-1.5 py-0.5 rounded border border-slate-700">Param</span>
                            <span class="text-[10px] bg-slate-900 text-blue-400 px-1.5 py-0.5 rounded border border-slate-700">Auto-Detected</span>
                        </div>
                    </div>
                </div>
            `;
            stackContainer.appendChild(item);

            updateProgress();
        }

        // 스택 제거 로직
        function removeStack(el, id) {
            el.closest('.stack-item').remove();
            metrics = metrics.filter(m => m.id !== id);
            if (metrics.length === 0) emptyState.style.display = 'flex';
            updateProgress();
        }

        // 진행률 업데이트 및 버튼 활성화
        function updateProgress() {
            const count = metrics.length;
            const max = 3; // 목표 개수 (데모용)
            const progress = Math.min(100, (count / max) * 100);

            document.getElementById('stack-count').innerText = count;
            document.getElementById('progress-text').innerText = Math.round(progress) + '%';
            document.getElementById('progress-bar').style.width = progress + '%';

            // 실행 버튼 활성화/비활성화
            if (count > 0) {
                runBtn.disabled = false;
                runBtn.className = "w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-sm transition-all duration-300 shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2 cursor-pointer";
                runBtn.innerHTML = `<span>Generate Simulation</span> <i class="fa-solid fa-arrow-right"></i>`;
            } else {
                runBtn.disabled = true;
                runBtn.className = "w-full py-3 bg-slate-800 text-slate-500 rounded-lg font-bold text-sm transition-all duration-300 flex items-center justify-center gap-2 cursor-not-allowed";
                runBtn.innerHTML = `<span>Generate Simulation</span>`;
            }
        }

        function scrollToBottom() {
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        // --- [핵심] 페이지 전환 로직 ---
        runBtn.addEventListener('click', function() {
            if (!targetSimulation) {
                alert("시뮬레이션 주제가 명확하지 않습니다. (반도체 or CPU를 언급해주세요)");
                return;
            }

            // 로딩 상태 전환
            runBtn.disabled = true;
            runBtn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Generating Context...`;
            
            // 1.2초 뒤 부모 창(index.html) 함수 호출
            setTimeout(() => {
                if (window.parent && window.parent.navigateFromChild) {
                    window.parent.navigateFromChild(targetSimulation);
                } else {
                    console.warn("부모 프레임을 찾을 수 없습니다. 독립 실행 모드로 이동합니다.");
                    if(targetSimulation === 'fab') window.location.href = 'fab_sim.html';
                    else window.location.href = 'hw_sim.html';
                }
            }, 1200);
        });

    </script>
</body>
</html>